cd src
echo building...

if [[ ! -f ~/.cargo/bin/cargo ]];
then
        echo "Cargo (and so Rust) is not installed. Attempting to install rust..."

	if [[ "$OSTYPE" == "linux-gnu" ]]; then
		if [[ ! -f /usr/bin/curl ]]; then
			apt-get update
			yes | apt-get install curl
		fi
	fi

        curl -sf -L https://static.rust-lang.org/rustup.sh | bash -s -- -y

        if [ $? -ne 0 ]; then
                echo >&2 "Error installing rust. Try manually installing it"
                exit 1
        fi

	~/.cargo/bin/rustup toolchain install nightly
	~/.cargo/bin/rustup override set nightly

        echo "Rust installed. Continuing..."
fi

echo building doc

if [[ "$OSTYPE" == "linux-gnu" ]]; then
	if [[ ! -f /usr/bin/python3 ]]; then
		apt-get update
		yes | apt-get install python3
		yes | apt-get install python-dev
	fi
fi
cd doc
python3 build.py
cd ..

echo building program

~/.cargo/bin/cargo +nightly build --release

mkdir -p build

# MacOS
if hash ./target/release/libaddcombq.dylib 2> /dev/null;
then
	cp ./target/release/libaddcombq.dylib ./build/_addcomb.so
fi

# Linux
if hash ./target/release/libaddcombq.so 2> /dev/null;
then
	cp ./target/release/libaddcombq.so ./build/_addcomb.so
fi
